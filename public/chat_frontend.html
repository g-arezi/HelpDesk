<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat do Chamado</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/mobile.css">
    <style>
        /* Modernização visual do chat */
        body { background: #f4f6fb; }
        .chat-container {
            max-width: 500px;
            margin: 40px auto;
            border: none;
            border-radius: 18px;
            padding: 28px 24px 18px 24px;
            background: linear-gradient(135deg, #fafdff 80%, #e3f0ff 100%);
            box-shadow: 0 6px 32px #0002, 0 1.5px 8px #1976d220;
            transition: background 0.3s, color 0.3s;
        }
        h2 {
            color: #111; /* preto no light */
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 18px;
            text-shadow: 0 2px 8px #1976d210;
            letter-spacing: 0.5px;
        }
        .chat-messages {
            height: 260px;
            overflow-y: auto;
            border: 1.5px solid #e3eaf2;
            padding: 12px;
            background: #fff;
            margin-bottom: 14px;
            border-radius: 10px;
            font-size: 1.04rem;
            color: #111; /* preto no light */
            box-shadow: 0 1px 4px #1976d208;
        }
        .chat-message { margin-bottom: 10px; color: #111; }
        .chat-message .author { font-weight: bold; color: #111; /* preto no light */ }
        .chat-message .timestamp { color: #888; font-size: 0.85em; margin-left: 8px; }
        .chat-form { display: flex; gap: 10px; margin-top: 6px; }
        .chat-form input, .chat-form button {
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid #cfd8dc;
            font-size: 1rem;
            transition: background 0.3s, color 0.3s, border 0.2s;
        }
        .chat-form input { flex: 1; background: #fafdff; color: #222; }
        .chat-form input:focus { border: 1.5px solid #1976d2; outline: none; background: #e3f0ff; }
        .chat-form button {
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            border: none;
            font-weight: bold;
            cursor: pointer;
            min-width: 90px;
            box-shadow: 0 2px 8px #1976d210;
        }
        .chat-form button:hover { background: #125ea7; }
        label {
            color: #1976d2;
            font-weight: 500;
            margin-right: 4px;
            font-size: 1rem;
            vertical-align: middle;
        }
        input[type="number"], input[type="email"], input[type="text"] {
            margin-right: 8px;
            margin-bottom: 6px;
            border-radius: 7px;
            border: 1.5px solid #cfd8dc;
            background: #fafdff;
            color: #222;
            font-size: 1rem;
            padding-left: 32px;
            box-sizing: border-box;
            transition: border 0.2s, background 0.3s;
        }
        input[type="number"]:focus, input[type="email"]:focus, input[type="text"]:focus {
            border: 1.5px solid #1976d2;
            background: #e3f0ff;
            outline: none;
        }
        /* Ícones embutidos nos inputs */
        #ticketId { background-image: url('data:image/svg+xml;utf8,<svg fill="%231976d2" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>'); background-repeat: no-repeat; background-position: 8px 50%; }
        #email { background-image: url('data:image/svg+xml;utf8,<svg fill="%231976d2" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'); background-repeat: no-repeat; background-position: 8px 50%; }
        #telefone { background-image: url('data:image/svg+xml;utf8,<svg fill="%231976d2" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.21c1.21.49 2.53.76 3.88.76a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.35.27 2.67.76 3.88a1 1 0 01-.21 1.11l-2.2 2.2z"/></svg>'); background-repeat: no-repeat; background-position: 8px 50%; }
        input[type="number"], input[type="email"], input[type="text"] { padding-left: 32px; }
        /* Botão carregar */
        #btnCarregar {
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            border: none;
            font-weight: bold;
            border-radius: 8px;
            min-width: 90px;
            box-shadow: 0 2px 8px #1976d210;
            transition: background 0.2s;
        }
        #btnCarregar:hover { background: #125ea7; }
        /* Night mode aprimorado */
        body.night { background: #181c24 !important; }
        .chat-container.night {
            background: linear-gradient(135deg, #232837 80%, #181c24 100%) !important;
            border: none !important;
            color: #e0e0e0 !important;
            box-shadow: 0 6px 32px #0006, 0 1.5px 8px #1976d220;
        }
        .chat-messages {
            color: #111; background: #fff;
        }
        .chat-message { color: #111; }
        .chat-message .author { color: #111; }
        .chat-message .timestamp { color: #888; }
        /* Night mode: tudo branco */
        body.night, .chat-container.night, .chat-messages.night, .chat-message.night, .chat-message .author.night, .chat-message .timestamp.night, label.night, input.night, button.night, h2.night {
            color: #fff !important;
        }
        label, label[for="ticketId"], label[for="email"], label[for="telefone"] {
            color: #111 !important;
        }
        label.night, label[for="ticketId"].night, label[for="email"].night, label[for="telefone"].night {
            color: #fff !important;
        }
        /* Responsividade */
        @media (max-width: 600px) {
            .chat-container { padding: 10px 2vw 10px 2vw; }
            .chat-messages { height: 180px; font-size: 0.98rem; }
            .chat-form input, .chat-form button { font-size: 0.98rem; }
            h2 { font-size: 1.15rem; }
        }
        /* Novo estilo para o botão Enviar */
        .chat-form button, .chat-form button.night {
            background: linear-gradient(90deg, #43a047 60%, #66bb6a 100%) !important;
            color: #fff !important;
            border: none !important;
        }
        .chat-form button:hover, .chat-form button.night:hover {
            background: #388e3c !important;
            color: #fff !important;
        }
        /* Seletor de modo noturno */
        .mode-switch {
            position: fixed;
            left: 18px;
            bottom: 18px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #232a36;
            border-radius: 18px;
            padding: 6px 14px 6px 10px;
            box-shadow: 0 2px 12px #0003;
            color: #fff;
            font-size: 1.05rem;
            font-weight: 500;
            border: 1px solid #232a36;
            transition: background 0.3s, color 0.3s;
        }
        .mode-switch.light {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #b3c6e0;
        }
        .mode-switch input[type="checkbox"] {
            width: 36px;
            height: 20px;
            appearance: none;
            background: #bdbdbd;
            outline: none;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
            cursor: pointer;
        }
        .mode-switch input[type="checkbox"]:checked {
            background: #1976d2;
        }
        .mode-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            transition: left 0.3s;
        }
        .mode-switch input[type="checkbox"]:checked::before {
            left: 19px;
        }
        .mode-switch .icon {
            font-size: 1.1em;
        }
        /* Adicione aqui outros modos escuros */

        /* Estilos responsivos para dispositivos móveis */
        @media screen and (max-width: 768px) {
            .chat-container {
                max-width: 100%;
                margin: 20px auto;
                padding: 20px 15px;
                border-radius: 10px;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            .chat-messages {
                height: 220px;
                padding: 10px;
            }
            
            .chat-form {
                flex-direction: column;
                gap: 8px;
            }
            
            .chat-form input, 
            .chat-form button {
                width: 100%;
                padding: 12px;
                font-size: 16px; /* Evita zoom no iOS */
            }
            
            .id-email-telefone {
                display: flex;
                flex-direction: column;
            }
            
            input[type="number"], 
            input[type="email"], 
            input[type="text"] {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
                padding: 12px 12px 12px 40px;
            }
            
            #btnCarregar {
                width: 100%;
                padding: 12px;
                margin-top: 5px;
            }
        }
        
        /* Estilos específicos para iPhone 15 (390px) */
        @media screen and (max-width: 390px) {
            .chat-container {
                padding: 15px 12px;
                margin: 10px auto;
            }
            
            h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            .chat-messages {
                height: 200px;
            }
            
            .chat-message {
                font-size: 0.95em;
            }
            
            .mode-switch {
                bottom: 10px;
                left: 10px;
                padding: 5px 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="mode-switch light" id="modeSwitch">
        <span class="icon" id="modeIcon">🌞</span>
        <input type="checkbox" id="modeToggle" aria-label="Alternar modo claro/noturno">
        <span id="modeLabel">Claro</span>
    </div>
    <div class="chat-container" id="chatContainer">
        <h2 id="chatTitle">💬 Chat do Chamado</h2>
        <div style="margin-bottom:10px;">
            <label for="ticketId" id="labelTicketId">🆔 ID do Chamado:</label>
            <input type="text" id="ticketId" placeholder="ID do Chamado" style="width:100px;">
            <label for="email" id="labelEmail">✉️ E-mail:</label>
            <input type="email" id="email" placeholder="Seu e-mail" style="width:180px;">
            <label for="telefone" id="labelTelefone">📱 Telefone:</label>
            <input type="text" id="telefone" placeholder="Seu telefone" style="width:120px;">
            <button onclick="loadMessages()" id="btnCarregar">Carregar</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <form class="chat-form" id="chatForm" onsubmit="return sendMessage(event)">
            <input type="text" id="author" placeholder="Seu nome" required>
            <input type="text" id="message" placeholder="Digite sua mensagem" required>
            <button type="submit">Enviar</button>
        </form>
    </div>
    <script>
    let currentTicketId = 1;

    function getAuthParams() {
        const email = document.getElementById('email').value.trim();
        const telefone = document.getElementById('telefone').value.trim();
        return { email, telefone };
    }

    function renderMessages(messages) {
        const chat = document.getElementById('chatMessages');
        chat.innerHTML = '';
        if (Array.isArray(messages)) {
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-message';
                div.innerHTML = `<span class="author">${msg.author}</span> <span class="timestamp">[${msg.timestamp}]</span><br>${msg.message}`;
                chat.appendChild(div);
            });
        } else if (messages && messages.error) {
            chat.innerHTML = `<div style='color:#d32f2f;font-weight:bold;'>${messages.error}</div>`;
        }
        chat.scrollTop = chat.scrollHeight;
    }

    function loadMessages() {
        currentTicketId = document.getElementById('ticketId').value;
        const { email, telefone } = getAuthParams();
        if (!email && !telefone) {
            renderMessages({ error: 'Informe seu e-mail ou telefone para acessar o chat.' });
            return;
        }
        const params = new URLSearchParams();
        if (email) params.append('email', email);
        if (telefone) params.append('telefone', telefone);
        fetch(`chat.php?id=${currentTicketId}&${params.toString()}`)
            .then(r => r.json())
            .then(renderMessages)
            .catch(() => renderMessages({ error: 'Erro ao carregar mensagens.' }));
    }

    function sendMessage(e) {
        e.preventDefault();
        const author = document.getElementById('author').value.trim();
        const message = document.getElementById('message').value.trim();
        const { email, telefone } = getAuthParams();
        if (!author || !message) return false;
        if (!email && !telefone) {
            renderMessages({ error: 'Informe seu e-mail ou telefone para enviar mensagens.' });
            return false;
        }
        const body = { author, message, email, telefone };        fetch(`chat.php?id=${currentTicketId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                document.getElementById('message').value = '';
                loadMessages();
            } else {
                renderMessages({ error: res.error || 'Erro ao enviar mensagem.' });
            }
        });
        return false;
    }

    // Atualiza o chat a cada 1 segundo (quase em tempo real)
    timer = setInterval(loadMessages, 1000);
    window.onload = function() {
        // Preenche campos a partir da URL (para integração com buscarchamados.html e quick_users)
        const params = new URLSearchParams(window.location.search);
        if (params.has('id')) document.getElementById('ticketId').value = params.get('id');
        if (params.has('email')) document.getElementById('email').value = params.get('email');
        if (params.has('telefone')) document.getElementById('telefone').value = params.get('telefone');
        if (params.has('author')) document.getElementById('author').value = params.get('author');
        loadMessages();
    };

    // Night mode implementation
    function applyNightMode(night) {
        const body = document.body;
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatFormInputs = document.querySelectorAll('.chat-form input');
        const chatFormButton = document.querySelector('.chat-form button');
        const h2 = document.getElementById('chatTitle');
        const labels = [
            document.getElementById('labelTicketId'),
            document.getElementById('labelEmail'),
            document.getElementById('labelTelefone')
        ];
        if (night) {
            body.classList.add('night');
            chatContainer.classList.add('night');
            chatMessages.classList.add('night');
            chatFormInputs.forEach(i => i.classList.add('night'));
            chatFormButton.classList.add('night');
            h2.classList.add('night');
            labels.forEach(l => l.classList.add('night'));
            document.getElementById('nightToggle').innerText = '☀️';
        } else {
            body.classList.remove('night');
            chatContainer.classList.remove('night');
            chatMessages.classList.remove('night');
            chatFormInputs.forEach(i => i.classList.remove('night'));
            chatFormButton.classList.remove('night');
            h2.classList.remove('night');
            labels.forEach(l => l.classList.remove('night'));
            document.getElementById('nightToggle').innerText = '🌙';
        }
    }
    function toggleNightMode() {
        const night = !(localStorage.getItem('nightMode') === 'true');
        localStorage.setItem('nightMode', night);
        applyNightMode(night);
    }
    // Apply night mode on load
    window.addEventListener('DOMContentLoaded', function() {
        applyNightMode(localStorage.getItem('nightMode') === 'true');
    });

    // Novo switch de modo igual ao buscarchamados.html
    const modeSwitch = document.getElementById('modeSwitch');
    const modeToggle = document.getElementById('modeToggle');
    const modeIcon = document.getElementById('modeIcon');
    const modeLabel = document.getElementById('modeLabel');
    function setMode(night) {
        document.body.classList.toggle('night', night);
        document.getElementById('chatContainer').classList.toggle('night', night);
        document.getElementById('chatMessages').classList.toggle('night', night);
        document.querySelectorAll('.chat-form input').forEach(i => i.classList.toggle('night', night));
        document.querySelector('.chat-form button').classList.toggle('night', night);
        document.getElementById('chatTitle').classList.toggle('night', night);
        [document.getElementById('labelTicketId'), document.getElementById('labelEmail'), document.getElementById('labelTelefone')].forEach(l => l.classList.toggle('night', night));
        modeSwitch.classList.toggle('light', !night);
        modeSwitch.classList.toggle('night', night);
        modeToggle.checked = night;
        if(night) {
            modeIcon.textContent = '🌙';
            modeLabel.textContent = 'Noturno';
            localStorage.setItem('nightMode','1');
        } else {
            modeIcon.textContent = '🌞';
            modeLabel.textContent = 'Claro';
            localStorage.removeItem('nightMode');
        }
    }
    modeToggle.addEventListener('change', function() {
        setMode(this.checked);
    });
    // Inicialização
    if(localStorage.getItem('nightMode')) setMode(true);
    else setMode(false);
    </script>
</body>
</html>
